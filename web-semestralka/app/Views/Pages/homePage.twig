{# app/Views/homePage.twig #}
{% extends "Layouts/base.twig" %}

{% block content %}

    {# flash zprávy podle toho, jak to máš udělané #}
    {% if flashMessageError %}
        {% include "Special/flashMessageError.twig" with { message: flashMessageError } %}
    {% endif %}
    {% if flashMessageSuccess %}
        {% include "Special/flashMessageSuccess.twig" with { message: flashMessageSuccess } %}
    {% endif %}

    {# FORGOT FLOW #}
    {% if forgotStage is defined and forgotStage %}
        {% if forgotStage == 'email' %}
            {% include "Forms/forgotPasswordEmail.twig" %}
        {% elseif forgotStage == 'code' %}
            {% include "Forms/forgotPasswordCode.twig" %}
        {% elseif forgotStage == 'new_password' %}
            {% include "Forms/changePasswordForm.twig" %}
        {% endif %}
    {% else %}
        {# původní obsah – registry / eventy #}
        {% if showRegister %}
            {% include "Forms/registerForm.twig" %}
        {% else %}
            {% block events %}
                {% include "Blocks/Cards/events.twig" %}
            {% endblock %}
        {% endif %}
    {% endif %}
    {% block javascripts %}
        <script>
            document.addEventListener('click', function (e) {

                // --- otevření USER modalu (klik na badge místa / tvůrce) ---
                const userTrigger = e.target.closest('.js-open-user-modal');
                if (userTrigger) {
                    e.preventDefault();
                    e.stopPropagation();

                    const userId = userTrigger.getAttribute('data-user-id');
                    if (!userId) return;

                    const modalEl = document.getElementById('userModal_' + userId);
                    if (!modalEl) return;

                    const currentModalEl = userTrigger.closest('.modal');
                    if (currentModalEl) {
                        const currentModal = bootstrap.Modal.getInstance(currentModalEl);
                        if (currentModal) currentModal.hide();
                    }

                    const userModal = new bootstrap.Modal(modalEl);
                    userModal.show();
                    return;
                }

                // --- otevření EVENT modalu z mini-karty v user modalu ---
                const eventTrigger = e.target.closest('.js-open-event-modal');
                if (eventTrigger) {
                    e.preventDefault();
                    e.stopPropagation();

                    const eventId = eventTrigger.getAttribute('data-event-id');
                    if (!eventId) return;

                    const currentModalEl = eventTrigger.closest('.modal');
                    if (currentModalEl) {
                        const currentModal = bootstrap.Modal.getInstance(currentModalEl);
                        if (currentModal) currentModal.hide();
                    }

                    const eventModalEl = document.getElementById('eventModal_' + eventId);
                    if (!eventModalEl) return;

                    const eventModal = new bootstrap.Modal(eventModalEl);
                    eventModal.show();
                }
            });
        </script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const grid = document.getElementById('events-grid');
                if (!grid) return;

                const perPage = parseInt(grid.dataset.perPage || '12', 10);
                const items = Array.from(grid.querySelectorAll('.js-event-item'));
                const totalPages = Math.max(1, Math.ceil(items.length / perPage));
                let currentPage = 1;

                function showPage(page) {
                    if (page < 1) page = 1;
                    if (page > totalPages) page = totalPages;
                    currentPage = page;

                    items.forEach((item, index) => {
                        const pageIndex = Math.floor(index / perPage) + 1;
                        item.style.display = (pageIndex === currentPage) ? '' : 'none';
                    });

                    // update active/disabled stavu pagination
                    document.querySelectorAll('.pagination .page-item').forEach(li => {
                        li.classList.remove('active', 'disabled');
                    });

                    document.querySelectorAll('.pagination a[data-page]').forEach(a => {
                        const p = a.dataset.page;
                        const li = a.parentElement;

                        if (p === 'prev') {
                            if (currentPage === 1) li.classList.add('disabled');
                        } else if (p === 'next') {
                            if (currentPage === totalPages) li.classList.add('disabled');
                        } else {
                            const num = parseInt(p, 10);
                            if (!isNaN(num) && num === currentPage) {
                                li.classList.add('active');
                            }
                        }
                    });
                }

                // klikání na pagination
                document.querySelectorAll('.pagination a[data-page]').forEach(a => {
                    a.addEventListener('click', function (e) {
                        e.preventDefault();
                        const p = this.dataset.page;

                        if (p === 'prev') {
                            showPage(currentPage - 1);
                        } else if (p === 'next') {
                            showPage(currentPage + 1);
                        } else {
                            const num = parseInt(p, 10);
                            if (!isNaN(num)) {
                                showPage(num);
                            }
                        }
                    });
                });

                // inicializace – zobraz první stránku
                showPage(1);
            });
        </script>
    {% endblock %}


{% endblock %}



